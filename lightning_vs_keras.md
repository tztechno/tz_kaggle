修正前の `run_cv` 関数には、主に以下の問題点がありました。これらが Keras バージョンと比較して性能が劣る原因となっていたと考えられます：

---

### 1. **データの前処理（正規化）が不足**
   - **問題点**: Keras バージョンでは各フォールドごとに訓練データから平均と標準偏差を計算し、正規化を実施しているのに対し、Lightning バージョンでは正規化が行われていない（または外部で行われている様子が見えない）。
   - **影響**: スケールが異なる特徴量がある場合、ニューラルネットワークの学習が不安定になり、収束が遅れる/精度が低下する。

---

### 2. **モデルの初期化と再現性**
   - **問題点**: Keras では `K.clear_session()` で各フォールドのモデルを完全にリセットしているが、Lightning バージョンでは明示的な重みの初期化が行われていない。
   - **影響**: フォールド間でモデルの状態がリークする可能性や、初期化のばらつきによる再現性の低下。

---

### 3. **Early Stopping とチェックポイントの扱い**
   - **問題点**: 
     - Early Stopping は実装されているが、`ModelCheckpoint` がなく、ベストモデルが保存されない。
     - 検証データの監視（`monitor="val_loss"`）はあるが、`min_delta`（最小改善幅）の指定がない。
   - **影響**: 過学習が始まっても気づかない、または最良のモデルを最終予測に使えない。

---

### 4. **最適化の設定が不明確**
   - **問題点**: Keras では `Adam(0.001)` と明示されているが、Lightning ではデフォルトのオプティマイザ設定に依存している。
   - **影響**: 学習率やモメンタムなどのハイパーパラメータが異なり、収束性に差が出る。

---

### 5. **データローダーの設定**
   - **問題点**: 検証用データローダー (`val_loader`) で `shuffle=True` になっている（デフォルトまたは未指定の場合）。
   - **影響**: 検証データの順序がランダム化され、評価指標の計算が不安定になる可能性。

---

### 6. **メモリ管理の不足**
   - **問題点**: `torch.cuda.empty_cache()` が呼ばれておらず、GPUメモリのフラグメンテーションが発生する可能性。
   - **影響**: 大規模データや複雑なモデルでメモリ不足エラーが起こりやすくなる。

---

### 7. **テストデータの正規化漏れ**
   - **問題点**: テストデータに対し、訓練データと同じ正規化（平均/標準偏差）が適用されていない。
   - **影響**: データのスケールが訓練時と異なり、予測が不正確になる。

---

### 8. **進捗表示とデバッグ情報**
   - **問題点**: `enable_progress_bar=False`, `enable_model_summary=False` で詳細な情報が表示されない。
   - **影響**: 学習中の問題（例: 勾配消失/爆発）に気づきにくい。

---

### 9. **デバイス管理の不明確さ**
   - **問題点**: `accelerator` の指定がなく、CPU/GPUの切り替えが不明確。
   - **影響**: 環境によって挙動が変わり、再現性が損なわれる。

---

### 10. **バッチ正規化（BatchNorm）の扱い**
   - **問題点**: モデルにBatchNorm層がある場合、検証時には `model.eval()` で統計量を固定する必要があるが、実装が不明確。
   - **影響**: 訓練/検証モードの切り替え漏れで精度が低下する。

---

### 修正が必要な根本的な原因
これらの問題は、**PyTorch LightningがKerasよりも「明示的な設定」を要求する**という設計の違いに起因しています。Kerasではデフォルトで行われる処理（正規化やセッションクリア）が、Lightningではユーザーが意識的に実装する必要があったのです。

特に、**データ正規化**と**モデルの状態リセット**の不足が、パフォーマンス差の主要因だったと考えられます。
